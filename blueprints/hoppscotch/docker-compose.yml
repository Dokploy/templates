version: "3.8"
services:
  hoppscotch-aio:
    # image: your-registry/hoppscotch-aio:latest  # Replace with pre-built image for Dokploy
    build:
      dockerfile: prod.Dockerfile
      context: .
      target: aio
    restart: unless-stopped
    ports:
      - 3000
      - 3100
      - 3170
      - 3200
      - 3080
    depends_on:
      hoppscotch-db:
        condition: service_healthy

  hoppscotch-db:
    image: postgres:15
    restart: always
    ports:
      - 5432
    user: postgres
    volumes:
      - db-data:/var/lib/postgresql/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "sh -c 'pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}'",
        ]
      interval: 5s
      timeout: 5s
      retries: 10

  hoppscotch-migrate:
    # image: your-registry/hoppscotch-backend:latest  # Replace with pre-built image for Dokploy
    build:
      dockerfile: prod.Dockerfile
      context: .
      target: backend
    restart: always
    command: sh -c "pnpx prisma migrate deploy"
    depends_on:
      hoppscotch-db:
        condition: service_healthy

  # Uncomment for backend profile
  # hoppscotch-backend:
  #   build:
  #     dockerfile: prod.Dockerfile
  #     context: .
  #     target: backend
  #   restart: always
  #   ports:
  #     - 3180
  #     - 3170
  #   volumes:
  #     - /usr/src/app/node_modules/
  #   depends_on:
  #     hoppscotch-db:
  #       condition: service_healthy

  # Uncomment for app profile
  # hoppscotch-app:
  #   build:
  #     dockerfile: prod.Dockerfile
  #     context: .
  #     target: app
  #   restart: always
  #   ports:
  #     - 3080
  #     - 3000
  #     - 3200
  #   depends_on:
  #     - hoppscotch-backend

  # Uncomment for admin profile
  # hoppscotch-sh-admin:
  #   build:
  #     dockerfile: prod.Dockerfile
  #     context: .
  #     target: sh_admin
  #   restart: always
  #   ports:
  #     - 3280
  #     - 3100
  #   depends_on:
  #     - hoppscotch-backend

  # Uncomment for default-no-db profile
  # hoppscotch-aio-no-db:
  #   build:
  #     dockerfile: prod.Dockerfile
  #     context: .
  #     target: aio
  #   restart: unless-stopped
  #   ports:
  #     - 3000
  #     - 3100
  #     - 3170
  #     - 3200
  #     - 3080

  # Uncomment for deprecated profile
  # hoppscotch-old-backend:
  #   build:
  #     dockerfile: packages/hoppscotch-backend/Dockerfile
  #     context: .
  #     target: prod
  #   restart: always
  #   ports:
  #     - 3170
  #   volumes:
  #     - /usr/src/app/node_modules/
  #   depends_on:
  #     hoppscotch-db:
  #       condition: service_healthy

  # hoppscotch-old-app:
  #   build:
  #     dockerfile: packages/hoppscotch-selfhost-web/Dockerfile
  #     context: .
  #   restart: always
  #   ports:
  #     - 3000
  #   depends_on:
  #     - hoppscotch-old-backend

  # hoppscotch-old-sh-admin:
  #   build:
  #     dockerfile: packages/hoppscotch-sh-admin/Dockerfile
  #     context: .
  #   restart: always
  #   ports:
  #     - 3100
  #   depends_on:
  #     - hoppscotch-old-backend

volumes:
  db-data:
