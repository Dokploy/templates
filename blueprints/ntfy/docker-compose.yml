x-env: &env
  environment:
    NTFY_BASE_URL: "${NTFY_BASE_URL}"
    NTFY_LISTEN_HTTP: "${NTFY_LISTEN_HTTP}"
    NTFY_LISTEN_HTTPS: "${NTFY_LISTEN_HTTPS}"
    NTFY_LISTEN_UNIX: "${NTFY_LISTEN_UNIX}"
    NTFY_LISTEN_UNIX_MODE: "${NTFY_LISTEN_UNIX_MODE}"
    NTFY_KEY_FILE: "${NTFY_KEY_FILE}"
    NTFY_CERT_FILE: "${NTFY_CERT_FILE}"
    NTFY_FIREBASE_KEY_FILE: "${NTFY_FIREBASE_KEY_FILE}"
    NTFY_CACHE_FILE: "${NTFY_CACHE_FILE}"
    NTFY_CACHE_DURATION: "${NTFY_CACHE_DURATION}"
    NTFY_CACHE_STARTUP_QUERIES: "${NTFY_CACHE_STARTUP_QUERIES}"
    NTFY_CACHE_BATCH_SIZE: "${NTFY_CACHE_BATCH_SIZE}"
    NTFY_CACHE_BATCH_TIMEOUT: "${NTFY_CACHE_BATCH_TIMEOUT}"
    NTFY_AUTH_FILE: "${NTFY_AUTH_FILE}"
    NTFY_AUTH_DEFAULT_ACCESS: "${NTFY_AUTH_DEFAULT_ACCESS}"
    NTFY_BEHIND_PROXY: "${NTFY_BEHIND_PROXY}"
    NTFY_PROXY_FORWARDED_HEADER: "${NTFY_PROXY_FORWARDED_HEADER}"
    NTFY_PROXY_TRUSTED_HOSTS: "${NTFY_PROXY_TRUSTED_HOSTS}"
    NTFY_ATTACHMENT_CACHE_DIR: "${NTFY_ATTACHMENT_CACHE_DIR}"
    NTFY_ATTACHMENT_TOTAL_SIZE_LIMIT: "${NTFY_ATTACHMENT_TOTAL_SIZE_LIMIT}"
    NTFY_ATTACHMENT_FILE_SIZE_LIMIT: "${NTFY_ATTACHMENT_FILE_SIZE_LIMIT}"
    NTFY_ATTACHMENT_EXPIRY_DURATION: "${NTFY_ATTACHMENT_EXPIRY_DURATION}"
    NTFY_SMTP_SENDER_ADDR: "${NTFY_SMTP_SENDER_ADDR}"
    NTFY_SMTP_SENDER_USER: "${NTFY_SMTP_SENDER_USER}"
    NTFY_SMTP_SENDER_PASS: "${NTFY_SMTP_SENDER_PASS}"
    NTFY_SMTP_SENDER_FROM: "${NTFY_SMTP_SENDER_FROM}"
    NTFY_SMTP_SERVER_LISTEN: "${NTFY_SMTP_SERVER_LISTEN}"
    NTFY_SMTP_SERVER_DOMAIN: "${NTFY_SMTP_SERVER_DOMAIN}"
    NTFY_SMTP_SERVER_ADDR_PREFIX: "${NTFY_SMTP_SERVER_ADDR_PREFIX}"
    NTFY_TWILIO_ACCOUNT: "${NTFY_TWILIO_ACCOUNT}"
    NTFY_TWILIO_AUTH_TOKEN: "${NTFY_TWILIO_AUTH_TOKEN}"
    NTFY_TWILIO_PHONE_NUMBER: "${NTFY_TWILIO_PHONE_NUMBER}"
    NTFY_TWILIO_VERIFY_SERVICE: "${NTFY_TWILIO_VERIFY_SERVICE}"
    NTFY_KEEPALIVE_INTERVAL: "${NTFY_KEEPALIVE_INTERVAL}"
    NTFY_MANAGER_INTERVAL: "${NTFY_MANAGER_INTERVAL}"
    NTFY_MESSAGE_SIZE_LIMIT: "${NTFY_MESSAGE_SIZE_LIMIT}"
    NTFY_MESSAGE_DELAY_LIMIT: "${NTFY_MESSAGE_DELAY_LIMIT}"
    NTFY_GLOBAL_TOPIC_LIMIT: "${NTFY_GLOBAL_TOPIC_LIMIT}"
    NTFY_UPSTREAM_BASE_URL: "${NTFY_UPSTREAM_BASE_URL}"
    NTFY_UPSTREAM_ACCESS_TOKEN: "${NTFY_UPSTREAM_ACCESS_TOKEN}"
    NTFY_VISITOR_ATTACHMENT_TOTAL_SIZE_LIMIT: "${NTFY_VISITOR_ATTACHMENT_TOTAL_SIZE_LIMIT}"
    NTFY_VISITOR_ATTACHMENT_DAILY_BANDWIDTH_LIMIT: "${NTFY_VISITOR_ATTACHMENT_DAILY_BANDWIDTH_LIMIT}"
    NTFY_VISITOR_EMAIL_LIMIT_BURST: "${NTFY_VISITOR_EMAIL_LIMIT_BURST}"
    NTFY_VISITOR_EMAIL_LIMIT_REPLENISH: "${NTFY_VISITOR_EMAIL_LIMIT_REPLENISH}"
    NTFY_VISITOR_MESSAGE_DAILY_LIMIT: "${NTFY_VISITOR_MESSAGE_DAILY_LIMIT}"
    NTFY_VISITOR_REQUEST_LIMIT_BURST: "${NTFY_VISITOR_REQUEST_LIMIT_BURST}"
    NTFY_VISITOR_REQUEST_LIMIT_REPLENISH: "${NTFY_VISITOR_REQUEST_LIMIT_REPLENISH}"
    NTFY_VISITOR_REQUEST_LIMIT_EXEMPT_HOSTS: "${NTFY_VISITOR_REQUEST_LIMIT_EXEMPT_HOSTS}"
    NTFY_VISITOR_SUBSCRIPTION_LIMIT: "${NTFY_VISITOR_SUBSCRIPTION_LIMIT}"
    NTFY_VISITOR_SUBSCRIBER_RATE_LIMITING: "${NTFY_VISITOR_SUBSCRIBER_RATE_LIMITING}"
    NTFY_VISITOR_PREFIX_BITS_IPV: "${NTFY_VISITOR_PREFIX_BITS_IPV}"
    NTFY_VISITOR_PREFIX_BITS_IPV: "${NTFY_VISITOR_PREFIX_BITS_IPV}"
    NTFY_WEB_ROOT: "${NTFY_WEB_ROOT}"
    NTFY_ENABLE_SIGNUP: "${NTFY_ENABLE_SIGNUP}"
    NTFY_ENABLE_LOGIN: "${NTFY_ENABLE_LOGIN}"
    NTFY_ENABLE_RESERVATIONS: "${NTFY_ENABLE_RESERVATIONS}"
    NTFY_REQUIRE_LOGIN: "${NTFY_REQUIRE_LOGIN}"
    NTFY_STRIPE_SECRET_KEY: "${NTFY_STRIPE_SECRET_KEY}"
    NTFY_STRIPE_WEBHOOK_KEY: "${NTFY_STRIPE_WEBHOOK_KEY}"
    NTFY_BILLING_CONTACT: "${NTFY_BILLING_CONTACT}"
    NTFY_WEB_PUSH_PUBLIC_KEY: "${NTFY_WEB_PUSH_PUBLIC_KEY}"
    NTFY_WEB_PUSH_PRIVATE_KEY: "${NTFY_WEB_PUSH_PRIVATE_KEY}"
    NTFY_WEB_PUSH_FILE: "${NTFY_WEB_PUSH_FILE}"
    NTFY_WEB_PUSH_EMAIL_ADDRESS: "${NTFY_WEB_PUSH_EMAIL_ADDRESS}"
    NTFY_WEB_PUSH_STARTUP_QUERIES: "${NTFY_WEB_PUSH_STARTUP_QUERIES}"
    NTFY_WEB_PUSH_EXPIRY_DURATION: "${NTFY_WEB_PUSH_EXPIRY_DURATION}"
    NTFY_WEB_PUSH_EXPIRY_WARNING_DURATION: "${NTFY_WEB_PUSH_EXPIRY_WARNING_DURATION}"
    NTFY_LOG_FORMAT: "${NTFY_LOG_FORMAT}"
    NTFY_LOG_FILE: "${NTFY_LOG_FILE}"
    NTFY_LOG_LEVEL: "${NTFY_LOG_LEVEL}"
services:
  ntfy:
    !!merge <<: *env
    image: binwiederhier/ntfy
    restart: unless-stopped
    command:
      - serve
    ports:
      - "${NTFY_PORT}"
    volumes:
      - ntfy-data:/var/lib/ntfy
      - ntfy-cache:/var/cache/ntfy
      - ntfy-templates:/etc/ntfy/templates/
      - ./certs:/certs
    healthcheck:
      test: ["CMD-SHELL", "wget -q --tries=1 http://localhost:4001/v1/health -O - | grep -Eo '\"healthy\"\\s*:\\s*true' || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 40s
volumes:
  ntfy-data:
  ntfy-cache:
  ntfy-templates:
