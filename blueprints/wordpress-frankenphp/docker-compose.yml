services:
  wordpress:
    image: wpeverywhere/frankenwp:latest-php8.3
    restart: unless-stopped
    ports:
      - "${HOST_PORT:-8080}:80"
    environment:
      # FrankenPHP
      SERVER_NAME: "${SERVER_NAME:-:80}"
      
      # Base de donn√©es WordPress
      WORDPRESS_DB_HOST: "${WORDPRESS_DB_HOST:-wp_db}"
      WORDPRESS_DB_USER: "${WORDPRESS_DB_USER:-wordpress}"
      WORDPRESS_DB_PASSWORD: "${WORDPRESS_DB_PASSWORD}"
      WORDPRESS_DB_NAME: "${WORDPRESS_DB_NAME}"
      WORDPRESS_TABLE_PREFIX: "${WORDPRESS_TABLE_PREFIX:-wp_}"
      
      # Debug WordPress
      WORDPRESS_DEBUG: "${WORDPRESS_DEBUG:-false}"
      
      # Configuration Cache
      CACHE_LOC: "${CACHE_LOC:-/var/www/html/wp-content/cache}"
      TTL: "${TTL:-6000}"
      PURGE_PATH: "${PURGE_PATH:-/__cache/purge}"
      PURGE_KEY: "${PURGE_KEY}"
      BYPASS_HOME: "${BYPASS_HOME:-false}"
      BYPASS_PATH_PREFIXES: "${BYPASS_PATH_PREFIXES:-/wp-admin,/wp-json}"
      CACHE_RESPONSE_CODES: "${CACHE_RESPONSE_CODES:-200,404,405}"
      
      # Caddy Options
      CADDY_GLOBAL_OPTIONS: "${CADDY_GLOBAL_OPTIONS:-auto_https disable_redirects}"
      
      # Configuration Extra
      WORDPRESS_CONFIG_EXTRA: "${WORDPRESS_CONFIG_EXTRA}"
        
    volumes:
      - wp_content:/var/www/html/wp-content
    depends_on:
      wp_db:
        condition: service_healthy
    tty: true

  wp_db:
    image: mariadb:11.5
    restart: unless-stopped
    environment:
      MARIADB_ROOT_PASSWORD: "${MARIADB_ROOT_PASSWORD}"
      MARIADB_DATABASE: "${MARIADB_DATABASE}"
      MARIADB_USER: "${MARIADB_USER:-wordpress}"
      MARIADB_PASSWORD: "${MARIADB_PASSWORD}"
    volumes:
      - wp_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

volumes:
  wp_data:
  wp_content:
