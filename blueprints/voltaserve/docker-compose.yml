version: "3.8"
services:
  cockroach:
    image: cockroachdb/cockroach:latest-v24.3
    restart: unless-stopped
    ports:
      - 26257
      - 18080
    volumes:
      - cockroach:/cockroach/cockroach-data
    command: start-single-node --insecure
    healthcheck:
      test: cockroach sql --insecure --execute='SELECT 1;' || exit 1
  minio:
    image: minio/minio:RELEASE.2024-11-07T00-52-20Z
    restart: unless-stopped
    ports:
      - 9000
      - 9001
    volumes:
      - minio:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: curl --fail http://127.0.0.1:9000/minio/health/live || exit 1
  meilisearch:
    image: getmeili/meilisearch:v1.11.3
    restart: unless-stopped
    ports:
      - 7700
    volumes:
      - meilisearch:/meili_data
    healthcheck:
      test: curl --fail http://127.0.0.1:7700/health || exit 1
  redis:
    image: redis:7.4.1
    restart: unless-stopped
    ports:
      - 6379
    volumes:
      - redis:/data
    healthcheck:
      test: redis-cli ping || exit 1
  maildev:
    image: maildev/maildev:2.2.1
    restart: unless-stopped
    ports:
      - 1025
      - 8025
    healthcheck:
      test: wget --quiet --spider http://127.0.0.1:1080 || exit 1
  api:
    image: voltaserve/api:latest
    restart: on-failure
    ports:
      - 8080
    healthcheck:
      test: wget --quiet --spider http://127.0.0.1:8080/v3/health || exit 1
    depends_on:
      - cockroach
      - redis
      - minio
      - meilisearch
  idp:
    image: voltaserve/idp:latest
    restart: on-failure
    ports:
      - 8081
    healthcheck:
      test: curl -fs http://127.0.0.1:8081/v3/health || exit 1
    depends_on:
      - cockroach
      - meilisearch
      - minio
  ui:
    image: voltaserve/ui:latest
    restart: on-failure
    ports:
      - 3000
    healthcheck:
      test: wget --quiet --spider http://127.0.0.1:3000/index.html || exit 1
    depends_on:
      - idp
      - api
  webdav:
    image: voltaserve/webdav:latest
    restart: on-failure
    ports:
      - 8082
    healthcheck:
      test: wget --quiet --spider http://127.0.0.1:8082/v3/health || exit 1
    depends_on:
      - idp
      - api
  conversion:
    image: voltaserve/conversion:latest
    restart: on-failure
    ports:
      - 8083
    healthcheck:
      test: curl -fs http://127.0.0.1:8083/v3/health || exit 1
    depends_on:
      - api
      - minio
  language:
    image: voltaserve/language:latest
    restart: on-failure
    ports:
      - 8084
    healthcheck:
      test: curl -fs http://127.0.0.1:8084/v3/health || exit 1
  mosaic:
    image: voltaserve/mosaic:latest
    restart: on-failure
    ports:
      - 8085
    healthcheck:
      test: wget --quiet --spider http://127.0.0.1:8085/v3/health || exit 1
  console:
    image: voltaserve/console:latest
    restart: on-failure
    ports:
      - 8086
    healthcheck:
      test: wget --quiet --spider http://127.0.0.1:8086/liveness || exit 1
    depends_on:
      - api
      - idp
      - webdav
      - conversion
      - language
      - mosaic
      - cockroach
  murph:
    image: voltaserve/murph:latest
    restart: on-failure
    ports:
      - 8087
    healthcheck:
      test: wget --quiet --spider http://127.0.0.1:8087/v1/health || exit 1
    depends_on:
      - cockroach
      - redis
      - minio
      - meilisearch
  migrations:
    image: voltaserve/migrations:latest
    restart: on-failure
    depends_on:
      - cockroach
volumes:
  cockroach:
  minio:
  meilisearch:
  redis:
