services:
  snapp:
    image: uraniadev/snapp:${SNAPP_VERSION:-0.9-rc-020}
    restart: unless-stopped
    ports:
      - 3000
    healthcheck:
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
      test:
        [
          "CMD",
          "curl",
          "--fail",
          "http://127.0.0.1:3000/health",
          "||",
          "exit",
          "1",
        ]
    environment:
      DATABASE_PROVIDER: ${DATABASE_PROVIDER}
      DATABASE_URL: ${DATABASE_URL}

      ADMIN_USERNAME: ${ADMIN_USERNAME}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}

      APPNAME: ${APPNAME}
      ORIGIN: ${ORIGIN}
      PUBLIC_URL: ${PUBLIC_URL}
      PORT: ${PORT}
      HOST: ${HOST}
      TOKEN_SECRET: ${TOKEN_SECRET}

      ENABLE_SIGNUP: ${ENABLE_SIGNUP}
      ENABLED_MFA: ${ENABLED_MFA}
      DISABLED_EMAIL_AND_PASSWORD: ${DISABLED_EMAIL_AND_PASSWORD}
      PUBLIC_EXTRA_GROUPS_EDITABLE: ${PUBLIC_EXTRA_GROUPS_EDITABLE}
      URLS_VIA_GROUPS_ONLY: ${URLS_VIA_GROUPS_ONLY}
      DISABLE_HOME: ${DISABLE_HOME}

      LOG_LEVEL: ${LOG_LEVEL}

      PUBLIC_UMAMI_URL: ${PUBLIC_UMAMI_URL}
      PUBLIC_UMAMI_WEBSITE_ID: ${PUBLIC_UMAMI_WEBSITE_ID}
      VTAPI_KEY: ${VTAPI_KEY}

      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASS: ${SMTP_PASS}
      SMTP_FROM: ${SMTP_FROM}
      SMTP_SSL: ${SMTP_SSL}

      AUTH_PROVIDERS: ${AUTH_PROVIDERS}
      AUTH_GOOGLE_CLIENT_ID: ${AUTH_GOOGLE_CLIENT_ID}
      AUTH_GOOGLE_CLIENT_SECRET: ${AUTH_GOOGLE_CLIENT_SECRET}
      AUTH_GOOGLE_ISSUER: ${AUTH_GOOGLE_ISSUER}
      AUTH_KEYCLOAK_CLIENT_ID: ${AUTH_KEYCLOAK_CLIENT_ID}
      AUTH_KEYCLOAK_CLIENT_SECRET: ${AUTH_KEYCLOAK_CLIENT_SECRET}
      AUTH_KEYCLOAK_CLIENT_SCOPE: ${AUTH_KEYCLOAK_CLIENT_SCOPE}
      AUTH_KEYCLOAK_ISSUER: ${AUTH_KEYCLOAK_ISSUER}
      AUTH_AUTHELIA_CLIENT_ID: ${AUTH_AUTHELIA_CLIENT_ID}
      AUTH_AUTHELIA_CLIENT_SECRET: ${AUTH_AUTHELIA_CLIENT_SECRET}
      AUTH_AUTHELIA_ISSUER: ${AUTH_AUTHELIA_ISSUER}

      PUBLIC_ADMIN_CONTACT: ${PUBLIC_ADMIN_CONTACT}
    volumes:
      - snapp_data:/app

  postgres:
    image: postgres:${POSTGRES_VERSION:-17.4-alpine}
    restart: unless-stopped
    profiles:
      - postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - 5432

  mariadb:
    image: mariadb:${MARIADB_VERSION:-latest}
    restart: unless-stopped
    profiles:
      - mariadb
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    volumes:
      - mariadb_data:/var/lib/mysql
    ports:
      - 3306
    healthcheck:
      test:
        [
          "CMD",
          "healthcheck.sh",
          "--su-mysql",
          "--connect",
          "--innodb_initialized",
        ]
      start_period: 1m
      start_interval: 10s
      interval: 1m
      timeout: 5s
      retries: 3

volumes:
  snapp_data:
  postgres_data:
  mariadb_data:
