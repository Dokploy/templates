services:
  wordpress:
    image: wpeverywhere/frankenwp:latest-php8.3
    volumes:
      - wp_content:/var/www/html/wp-content
      - wp_cache:/var/www/html/wp-content/cache
      - ../files/uploads.ini:/usr/local/etc/php/conf.d/uploads.ini
    environment:
      # Base de donnÃ©es
      DB_NAME: $DB_NAME
      DB_USER: $DB_USER
      DB_PASSWORD: $DB_PASSWORD
      DB_HOST: $DB_HOST
      DB_TABLE_PREFIX: $DB_TABLE_PREFIX
      
      # WordPress
      WP_DEBUG: $WP_DEBUG
      FORCE_HTTPS: $FORCE_HTTPS
      WORDPRESS_CONFIG_EXTRA: $WORDPRESS_CONFIG_EXTRA
      
      # FrankenPHP
      SERVER_NAME: $SERVER_NAME
      CADDY_GLOBAL_OPTIONS: $CADDY_GLOBAL_OPTIONS
      FRANKENPHP_CONFIG: $FRANKENPHP_CONFIG
      
      # Cache Sidekick
      CACHE_LOC: $CACHE_LOC
      CACHE_RESPONSE_CODES: $CACHE_RESPONSE_CODES
      BYPASS_PATH_PREFIX: $BYPASS_PATH_PREFIX
      BYPASS_HOME: $BYPASS_HOME
      PURGE_KEY: $PURGE_KEY
      PURGE_PATH: $PURGE_PATH
      TTL: $TTL
    depends_on:
      wp_db:
        condition: service_healthy
    restart: unless-stopped
    labels:
      - "traefik.enable=false"
      - "frankenwp.cache.enabled=true"

  wp_db:
    image: mariadb:11.5
    restart: unless-stopped
    volumes:
      - wp_data:/var/lib/mysql
    environment:
      MARIADB_ROOT_PASSWORD: $DB_PASSWORD
      MARIADB_DATABASE: $DB_NAME
      MARIADB_USER: wordpress
      MARIADB_PASSWORD: $DB_PASSWORD
    healthcheck:
      test: ["CMD-SHELL", "healthcheck.sh --connect --innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    command: >
      --innodb-buffer-pool-size=256M
      --innodb-log-file-size=64M
      --max-connections=200
      --query-cache-size=32M
      --query-cache-type=1

volumes:
  wp_data:
  wp_content:
  wp_cache:
