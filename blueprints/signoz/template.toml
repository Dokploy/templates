[variables]
main_domain = "${domain}"

[config]
[[config.domains]]
serviceName = "signoz"
port = 8080
host = "${main_domain}"
path = "/"

[[config.mounts]]
filePath = "./clickhouse/config.xml"
content = """
<?xml version=\"1.0\"?>
<clickhouse>
  <logger>
    <level>information</level>
    <formatting>
      <type>json</type>
    </formatting>
    <log>/var/log/clickhouse-server/clickhouse-server.log</log>
    <errorlog>/var/log/clickhouse-server/clickhouse-server.err.log</errorlog>
    <size>1000M</size>
    <count>10</count>
  </logger>
  <http_port>8123</http_port>
  <tcp_port>9000</tcp_port>
  <mysql_port>9004</mysql_port>
  <postgresql_port>9005</postgresql_port>
  <interserver_http_port>9009</interserver_http_port>
  <max_connections>4096</max_connections>
  <keep_alive_timeout>3</keep_alive_timeout>
  <merge_tree_metadata_cache>
    <lru_cache_size>268435456</lru_cache_size>
    <continue_if_corrupted>true</continue_if_corrupted>
  </merge_tree_metadata_cache>
</clickhouse>
"""

[[config.mounts]]
filePath = "./clickhouse/users.xml"
content = """
<?xml version=\"1.0\"?>
<clickhouse>
  <profiles>
    <default>
      <max_memory_usage>10000000000</max_memory_usage>
      <load_balancing>random</load_balancing>
    </default>
    <readonly>
      <readonly>1</readonly>
    </readonly>
  </profiles>
  <users>
    <default>
      <password></password>
      <networks>
        <ip>::/0</ip>
      </networks>
      <profile>default</profile>
      <quota>default</quota>
    </default>
  </users>
  <quotas>
    <default>
      <interval>
        <duration>3600</duration>
        <queries>0</queries>
        <errors>0</errors>
        <result_rows>0</result_rows>
        <read_rows>0</read_rows>
        <execution_time>0</execution_time>
      </interval>
    </default>
  </quotas>
</clickhouse>
"""

[[config.mounts]]
filePath = "./clickhouse/custom-function.xml"
content = """
<functions>
  <function>
    <type>executable</type>
    <name>histogramQuantile</name>
    <return_type>Float64</return_type>
    <argument>
      <type>Array(Float64)</type>
      <name>buckets</name>
    </argument>
    <argument>
      <type>Array(Float64)</type>
      <name>counts</name>
    </argument>
    <argument>
      <type>Float64</type>
      <name>quantile</name>
    </argument>
    <format>CSV</format>
    <command>./histogramQuantile</command>
  </function>
</functions>
"""

[[config.mounts]]
filePath = "./clickhouse/cluster.xml"
content = """
<?xml version=\"1.0\"?>
<clickhouse>
  <zookeeper>
    <node index=\"1\">
      <host>zookeeper-1</host>
      <port>2181</port>
    </node>
  </zookeeper>
  <remote_servers>
    <cluster>
      <shard>
        <replica>
          <host>clickhouse</host>
          <port>9000</port>
        </replica>
      </shard>
    </cluster>
  </remote_servers>
</clickhouse>
"""

[[config.mounts]]
filePath = "./signoz/prometheus.yml"
content = """
global:
  scrape_interval: 5s
  evaluation_interval: 15s
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093
rule_files: []
scrape_configs: []
remote_read:
  - url: tcp://clickhouse:9000/signoz_metrics
"""

[[config.mounts]]
filePath = "./collector/otel-collector-config.yaml"
content = """
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318
  prometheus:
    config:
      global:
        scrape_interval: 60s
      scrape_configs:
        - job_name: otel-collector
          static_configs:
            - targets:
                - localhost:8888
              labels:
                job_name: otel-collector
processors:
  batch:
    send_batch_size: 10000
    send_batch_max_size: 11000
    timeout: 10s
  resourcedetection:
    detectors: [env, system]
    timeout: 2s
  signozspanmetrics/delta:
    metrics_exporter: signozclickhousemetrics
    metrics_flush_interval: 60s
    latency_histogram_buckets: [100us, 1ms, 2ms, 6ms, 10ms, 50ms, 100ms, 250ms, 500ms, 1000ms, 1400ms, 2000ms, 5s, 10s, 20s, 40s, 60s]
    dimensions_cache_size: 100000
    aggregation_temporality: AGGREGATION_TEMPORALITY_DELTA
    enable_exp_histogram: true
    dimensions:
      - name: service.namespace
        default: default
      - name: deployment.environment
        default: default
      - name: signoz.collector.id
      - name: service.version
      - name: browser.platform
      - name: browser.mobile
      - name: k8s.cluster.name
      - name: k8s.node.name
      - name: k8s.namespace.name
      - name: host.name
      - name: host.type
      - name: container.name
extensions:
  health_check:
    endpoint: 0.0.0.0:13133
  pprof:
    endpoint: 0.0.0.0:1777
exporters:
  clickhousetraces:
    datasource: tcp://clickhouse:9000/signoz_traces
    low_cardinal_exception_grouping: ${env:LOW_CARDINAL_EXCEPTION_GROUPING}
    use_new_schema: true
  signozclickhousemetrics:
    dsn: tcp://clickhouse:9000/signoz_metrics
  clickhouselogsexporter:
    dsn: tcp://clickhouse:9000/signoz_logs
    timeout: 10s
    use_new_schema: true
service:
  telemetry:
    logs:
      encoding: json
  extensions:
    - health_check
    - pprof
  pipelines:
    traces:
      receivers: [otlp]
      processors: [signozspanmetrics/delta, batch]
      exporters: [clickhousetraces]
    metrics:
      receivers: [otlp]
      processors: [batch]
      exporters: [signozclickhousemetrics]
    metrics/prometheus:
      receivers: [prometheus]
      processors: [batch]
      exporters: [signozclickhousemetrics]
    logs:
      receivers: [otlp]
      processors: [batch]
      exporters: [clickhouselogsexporter]
"""


[[config.mounts]]
filePath = "./collector/signoz-opamp-config.yaml"
content = """
server_endpoint: ws://signoz:4320/v1/opamp
"""
