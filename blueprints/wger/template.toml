[variables]
#-- General Settings --#
main_domain = "${domain}"
timezone = "Europe/Berlin"
min_account_age_to_trust = "21"
download_ingredients_from = "WGER"

#-- Application Behavior --#
allow_registration = "True"
allow_guest_users = "True"
allow_upload_videos = "True"

#-- Sync Settings (Celery) --#
sync_exercises_celery = "True"
sync_exercise_images_celery = "True"
sync_exercise_videos_celery = "True"
sync_ingredients_celery = "True"

#-- Celery --#
use_celery = "True"

#-- Database Credentials (Auto-generated) --#
postgres_user = "wger"
postgres_password = "${password:32}"
postgres_db = "wger"

#-- Security Keys (Auto-generated) --#
secret_key = "${password:64}"
signing_key = "${password:64}"
flower_password = "${password:16}"

#-- Email Settings (Optional) --#
enable_email = "False"
email_host = "smtp.gmail.com"
email_port = "587"
email_host_user = "noreply@wger.de"
email_use_tls = "True"
from_email = "noreply@wger.de"

[config]
[[config.domains]]
serviceName = "nginx"
port = 80
host = "${main_domain}"

[config.env]
# Django's secret key, change to a 50 character random string if you are running
# this instance publicly. For an online generator, see e.g. https://djecrety.ir/
SECRET_KEY="${secret_key}"

# Signing key used for JWT, use something different than the secret key
SIGNING_KEY="${signing_key}"

# The server's timezone
TIME_ZONE="${timezone}"
TZ="${timezone}"

# Application Settings
WGER_INSTANCE="https://wger.de"
ALLOW_REGISTRATION="${allow_registration}"
ALLOW_GUEST_USERS="${allow_guest_users}"
ALLOW_UPLOAD_VIDEOS="${allow_upload_videos}"
MIN_ACCOUNT_AGE_TO_TRUST="${min_account_age_to_trust}"
SYNC_EXERCISES_CELERY="${sync_exercises_celery}"
SYNC_EXERCISE_IMAGES_CELERY="${sync_exercise_images_celery}"
SYNC_EXERCISE_VIDEOS_CELERY="${sync_exercise_videos_celery}"
SYNC_INGREDIENTS_CELERY="${sync_ingredients_celery}"
DOWNLOAD_INGREDIENTS_FROM="${download_ingredients_from}"
USE_CELERY="${use_celery}"

# Celery
CELERY_BROKER="redis://cache:6379/2"
CELERY_BACKEND="redis://cache:6379/2"
CELERY_FLOWER_PASSWORD="${flower_password}"

# Database
DJANGO_DB_ENGINE="django.db.backends.postgresql"
DJANGO_DB_DATABASE="${postgres_db}"
DJANGO_DB_USER="${postgres_user}"
DJANGO_DB_PASSWORD="${postgres_password}"
DJANGO_DB_HOST="db"
DJANGO_DB_PORT="5432"
DJANGO_PERFORM_MIGRATIONS="True"

# Cache
DJANGO_CACHE_BACKEND="django_redis.cache.RedisCache"
DJANGO_CACHE_LOCATION="redis://cache:6379/1"
DJANGO_CACHE_TIMEOUT="1296000"
DJANGO_CACHE_CLIENT_CLASS="django_redis.client.DefaultClient"

# Brute force login attacks
AXES_ENABLED="True"
AXES_FAILURE_LIMIT="10"
AXES_COOLOFF_TIME="30"
AXES_HANDLER="axes.handlers.cache.AxesCacheHandler"
AXES_LOCKOUT_PARAMETERS="ip_address"
AXES_IPWARE_PROXY_COUNT="1"
AXES_IPWARE_META_PRECEDENCE_ORDER="HTTP_X_FORWARDED_FOR,REMOTE_ADDR"

# Others
DJANGO_DEBUG="False"
WGER_USE_GUNICORN="True"
EXERCISE_CACHE_TTL="18000"
SITE_URL="http://localhost"
ACCESS_TOKEN_LIFETIME="10"
REFRESH_TOKEN_LIFETIME="24"
LOG_LEVEL_PYTHON="INFO"
USE_RECAPTCHA="False"
DJANGO_CLEAR_STATIC_FIRST="False"
NUMBER_OF_PROXIES="1"
GUNICORN_CMD_ARGS="--workers 3 --threads 2 --worker-class gthread --proxy-protocol True --timeout 240"

# Email
ENABLE_EMAIL="${enable_email}"
EMAIL_HOST="${email_host}"
EMAIL_PORT="${email_port}"
EMAIL_HOST_USER="${email_host_user}"
EMAIL_HOST_PASSWORD=""
EMAIL_USE_TLS="${email_use_tls}"
FROM_EMAIL="wger Workout Manager <${from_email}>"

[[config.mounts]]
serviceName = "nginx"
filePath = "/etc/nginx/conf.d/default.conf"
content = """
upstream wger {
    server web:8000;
}

server {
    listen 80;
    server_name ${main_domain};
    client_max_body_size 50M;

    location / {
        proxy_pass http://wger;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
    }

    location /static/ {
        alias /wger/static/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    location /media/ {
        alias /wger/media/;
        expires 7d;
        add_header Cache-Control "public";
    }
}
"""

[[config.mounts]]
serviceName = "cache"
filePath = "/usr/local/etc/redis/redis.conf"
content = """
# Wger-specific Redis Configuration
bind 0.0.0.0
protected-mode no
port 6379

# Set a 1GB memory limit to prevent runaway RAM usage
maxmemory 1gb

# IMPORTANT: Evict only keys with an expiration set (LRU)
maxmemory-policy volatile-lru

# Persistence settings from official Wger config
save 3600 1 300 100 60 10000

# Standard Redis settings for persistence
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /data
loglevel notice
logfile ""
"""
